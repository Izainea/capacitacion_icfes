<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lección 1: Conexión a Bases de Datos con DBI (Versión Extendida)</title>
    
    <!-- Google Fonts y Estilos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />

    <style>
        :root {
            --icfes-blue-primary: #004884;
            --icfes-yellow-accent: #F9C22E;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary-color: var(--icfes-yellow-accent);
            --secondary-color: var(--icfes-blue-primary);
            --text-color: #e0e0e0;
            --text-muted: #a0a0e0;
            --border-color: #333;
            --link-color: #5dade2;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            margin: 0; padding: 0;
        }
        .container { max-width: 1000px; margin: auto; padding: 20px; }
        h1, h2, h3, h4 { font-family: 'Teko', sans-serif; color: var(--primary-color); letter-spacing: 1px; }
        .main-header {
            background: var(--secondary-color);
            padding: 60px 20px;
            border-bottom: 4px solid var(--primary-color);
            text-align: center;
        }
        .main-header h1 { font-size: 3.5rem; }
        .main-header p { font-size: 1.3rem; color: var(--text-muted); }
        .section { padding: 40px 0; }
        .section-title { font-size: 2.8rem; border-bottom: 2px solid var(--primary-color); display: inline-block; padding-bottom: 10px; margin-bottom: 40px; }
        .content-block { background-color: var(--card-bg); border-left: 4px solid var(--secondary-color); padding: 2rem; border-radius: 8px; margin-bottom: 40px; }
        code.inline-code { background-color: #2a2a2a; padding: 0.2em 0.4em; border-radius: 3px; font-family: 'Courier New', Courier, monospace; color: var(--link-color); }
        pre[class*="language-"] { border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 50px; }
        .nav-button { display: inline-block; background-color: var(--primary-color); color: var(--secondary-color); padding: 12px 25px; border-radius: 5px; font-weight: bold; font-family: 'Teko', sans-serif; font-size: 1.5rem; text-decoration: none; transition: background-color 0.3s ease; }
        .nav-button:hover { background-color: #fbd25b; }
        .nav-button.back { background-color: #444; color: var(--text-color); }
        .nav-button.back:hover { background-color: #555; }
        .alert { padding: 1.5rem; border-radius: 8px; border-left: 4px solid; margin-bottom: 20px; }
        .alert-info { background-color: rgba(93, 173, 226, 0.1); border-color: var(--link-color); }
        .alert-danger { background-color: rgba(220, 53, 69, 0.1); border-color: #dc3545; }
        .alert-success { background-color: rgba(40, 167, 69, 0.1); border-color: #28a745; }

        /* Estilos para el diagrama ER */
        .er-diagram-container {
            position: relative;
            width: 100%;
            height: 550px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            align-items: center;
            justify-items: center;
        }
        .er-entity {
            background-color: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            width: 250px;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .er-entity h4 {
            font-family: 'Teko', sans-serif;
            color: var(--primary-color);
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.5rem;
        }
        .er-entity ul { list-style-type: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .er-entity li { padding: 4px 0; color: var(--text-muted); }
        .er-entity .pk { color: var(--link-color); font-weight: bold; }
        .er-entity .fk { color: #e3823c; font-weight: bold; }
        #fact-table { grid-column: 2; grid-row: 1 / span 2; height: 350px; }
        #dim-estudiantes { grid-column: 1; grid-row: 1; }
        #dim-colegios { grid-column: 3; grid-row: 1; }
        #dim-examenes { grid-column: 1; grid-row: 2; }

        .er-diagram-container svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .er-diagram-container .line { stroke: var(--border-color); stroke-width: 2; stroke-dasharray: 5, 5; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            font-family: 'Teko', sans-serif;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="container">
            <h1>Conexión a Bases de Datos con `DBI`</h1>
            <p>Accediendo a datos relacionales de forma estandarizada y eficiente.</p>
        </div>
    </header>

    <main class="container">
        
        <section class="section">
            <h2 class="section-title">El Salto a Producción: De Archivos a Bases de Datos</h2>
            <div class="content-block">
                <p>Una aplicación Shiny que lee un archivo <code class="inline-code">.csv</code> o <code class="inline-code">.txt</code> es un prototipo. Para que una aplicación sea considerada de nivel profesional o empresarial, debe interactuar con una fuente de datos centralizada, robusta y eficiente. Aquí es donde entran las bases de datos.</p>
                
                <h4>Comparativa: Archivo Plano vs. Base de Datos</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Criterio</th>
                            <th>Archivo Plano (.csv, .txt)</th>
                            <th>Base de Datos Relacional (SQL)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Rendimiento</strong></td>
                            <td>Lento. R debe cargar todo el archivo en memoria para cualquier operación.</td>
                            <td>Rápido. Delega el filtrado y la agregación al motor de la DB, que solo devuelve el resultado.</td>
                        </tr>
                        <tr>
                            <td><strong>Integridad de Datos</strong></td>
                            <td>Baja. No hay reglas, propenso a errores de formato y duplicados.</td>
                            <td>Alta. Se define un esquema estricto, tipos de datos y relaciones.</td>
                        </tr>
                        <tr>
                            <td><strong>Concurrencia</strong></td>
                            <td>Nula. Múltiples escrituras pueden corromper el archivo.</td>
                            <td>Alta. Diseñadas para manejar miles de conexiones simultáneas de forma segura.</td>
                        </tr>
                        <tr>
                            <td><strong>Escalabilidad</strong></td>
                            <td>Pobre. Los archivos de varios Gigabytes son inmanejables para R.</td>
                            <td>Excelente. Manejan Terabytes de datos de forma eficiente.</td>
                        </tr>
                        <tr>
                            <td><strong>Seguridad</strong></td>
                            <td>Baja. Control de acceso a nivel de sistema de archivos.</td>
                            <td>Alta. Permisos granulares por usuario, tabla o incluso columna.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h2 class="section-title">El Ecosistema `DBI` en R</h2>
            <div class="content-block">
                <p>El paquete <code class="inline-code">DBI</code> (Database Interface) es el estándar de oro en R. No se conecta directamente a la base de datos, sino que actúa como una **interfaz universal**. Proporciona un conjunto consistente de funciones (<code class="inline-code">dbConnect</code>, <code class="inline-code">dbGetQuery</code>, etc.) que funcionan igual sin importar la base de datos subyacente.</p>
                <p>Para cada tipo de base de datos, se utiliza un paquete "backend" o "driver" que traduce las llamadas de `DBI` al lenguaje específico del motor.</p>
                <ul>
                    <li>Para <strong>SQLite</strong> (nuestro caso): <code class="inline-code">RSQLite</code></li>
                    <li>Para <strong>PostgreSQL</strong>: <code class="inline-code">RPostgres</code></li>
                    <li>Para <strong>SQL Server, Oracle, etc.</strong>: <code class="inline-code">odbc</code></li>
                </ul>
                <p>Este enfoque modular es poderoso: si mañana migras tu base de datos de SQLite a PostgreSQL, solo necesitas cambiar la línea de conexión; el resto de tu código de consulta permanece idéntico.</p>
            </div>

            <h2 class="section-title">Nuestro Blueprint: El Esquema en Estrella y su SQL</h2>
            <div class="content-block">
                <p>Nuestra base de datos <code class="inline-code">icfes_data.db</code> utiliza un esquema en estrella. A continuación se muestra el diagrama y el código SQL para crear cada tabla.</p>
                <div class="er-diagram-container">
                    <svg>
                        <line x1="28%" y1="25%" x2="45%" y2="50%" class="line" />
                        <line x1="72%" y1="25%" x2="55%" y2="50%" class="line" />
                        <line x1="28%" y1="75%" x2="45%" y2="50%" class="line" />
                    </svg>
                    <div id="dim-estudiantes" class="er-entity"><h4><i class="fa-solid fa-user"></i> Estudiantes</h4><ul><li><span class="pk">estudiante_id (PK)</span></li><li>estrato</li></ul></div>
                    <div id="fact-table" class="er-entity"><h4><i class="fa-solid fa-table-list"></i> Resultados (Hechos)</h4><ul><li><span class="pk">resultado_id (PK)</span></li><li><span class="fk">estudiante_id (FK)</span></li><li><span class="fk">cole_dane_sede (FK)</span></li><li><span class="fk">examen_id (FK)</span></li><li>punt_global</li><li>... y otros puntajes</li></ul></div>
                    <div id="dim-colegios" class="er-entity"><h4><i class="fa-solid fa-school"></i> Colegios</h4><ul><li><span class="pk">cole_dane_sede (PK)</span></li><li>cole_nombre_sede</li><li>cole_naturaleza</li></ul></div>
                    <div id="dim-examenes" class="er-entity"><h4><i class="fa-solid fa-calendar-alt"></i> Examenes</h4><ul><li><span class="pk">examen_id (PK)</span></li><li>periodo</li></ul></div>
                </div>

                <h4>Definición de Tablas (SQL DDL)</h4>
<pre><code class="language-sql">
-- Tabla de Dimensión: Colegios
CREATE TABLE Colegios (
    cole_dane_sede TEXT PRIMARY KEY,
    cole_nombre_sede TEXT,
    cole_naturaleza TEXT,
    cole_municipio TEXT,
    cole_departamento TEXT
);

-- Tabla de Dimensión: Examenes
CREATE TABLE Examenes (
    examen_id INTEGER PRIMARY KEY,
    periodo TEXT NOT NULL
);

-- Tabla de Hechos: Resultados
CREATE TABLE Resultados (
    resultado_id INTEGER PRIMARY KEY AUTOINCREMENT,
    estudiante_id TEXT,
    cole_dane_sede TEXT,
    examen_id INTEGER,
    punt_global INTEGER,
    punt_matematicas INTEGER,
    -- ... otros puntajes
    FOREIGN KEY (cole_dane_sede) REFERENCES Colegios(cole_dane_sede),
    FOREIGN KEY (examen_id) REFERENCES Examenes(examen_id)
);
</code></pre>
            </div>

            <h2 class="section-title">El Ciclo de Vida de una Consulta Segura</h2>
            <div class="content-block">
                <p>Toda interacción con una base de datos debe seguir un ciclo de tres pasos riguroso, especialmente dentro de una aplicación Shiny.</p>
                
                <h3>El Patrón Profesional: `tryCatch` con `finally`</h3>
                <p>Para garantizar que la conexión siempre se cierre, incluso si ocurre un error durante la consulta, envolvemos nuestro código en un bloque <code class="inline-code">tryCatch</code>. El código dentro de <code class="inline-code">finally</code> se ejecutará sin importar qué pase, previniendo conexiones "colgadas".</p>
<pre><code class="language-r">
con <- NULL # Inicializar la conexión como NULL
tryCatch({
    # 1. CONECTAR
    con <- dbConnect(RSQLite::SQLite(), dbname = "database/icfes_data.db")
    
    # 2. CONSULTAR (de forma segura)
    depto_seleccionado <- "BOGOTA D.C." # Esto vendría de un input$ de Shiny
    query <- "SELECT * FROM Colegios WHERE cole_departamento = ?;"
    datos <- dbGetQuery(con, query, params = list(depto_seleccionado))
    
}, error = function(e) {
    # Manejar el error, por ejemplo, mostrar una notificación en Shiny
    showNotification(paste("Error en la base de datos:", e$message), type = "error")
    
}, finally = {
    # 3. DESCONECTAR (SIEMPRE se ejecuta)
    if (!is.null(con)) {
        dbDisconnect(con)
    }
})
</code></pre>
                <div class="alert alert-danger">
                    <h4><i class="fa-solid fa-shield-halved"></i> Seguridad Primero: Previniendo Inyección de SQL</h4>
                    <p>Nunca, bajo ninguna circunstancia, construyas una consulta SQL pegando texto con <code class="inline-code">paste()</code> o <code class="inline-code">glue()</code>. Esto abre una vulnerabilidad masiva llamada **Inyección de SQL**.</p>
                    <p><strong>El Camino Incorrecto (INSEGURO):</strong></p>
<pre><code class="language-r">
# ¡NO HACER ESTO!
depto <- input$depto_select # Imagina que el usuario escribe: "BOGOTA D.C.'; DROP TABLE Resultados; --"
query <- paste0("SELECT * FROM Colegios WHERE cole_departamento = '", depto, "';")
dbGetQuery(con, query) # ¡Acabas de borrar tu tabla de resultados!
</code></pre>
                    <p><strong>El Camino Correcto (SEGURO):</strong></p>
                    <p>Usa siempre consultas parametrizadas. `DBI` se encarga de "sanitizar" el input, tratando cualquier valor del usuario como un dato, no como código SQL ejecutable.</p>
<pre><code class="language-r">
query <- "SELECT * FROM Colegios WHERE cole_departamento = ?;"
datos <- dbGetQuery(con, query, params = list(input$depto_select))
</code></pre>
                </div>
            </div>

            <h2 class="section-title">Caso Práctico: Deconstruyendo el `app.R` de Monitoreo</h2>
            <div class="content-block">
                <p>Nuestra aplicación de monitoreo es el ejemplo perfecto de estos conceptos en acción. Demuestra por qué el esfuerzo de crear una base de datos vale la pena.</p>
                
                <h3>La Prueba Definitiva: Rendimiento</h3>
                <p>Al presionar "Ejecutar Comparativa", el servidor demuestra que delegar el trabajo a la base de datos es órdenes de magnitud más rápido que procesar un archivo plano en R.</p>
<pre><code class="language-r">
# Fragmento del server en app.R
observeEvent(input$run_benchmark, {
    # ...
    # --- Método Base de Datos (Rápido) ---
    start_time_db <- Sys.time()
    
    con <- dbConnect(RSQLite::SQLite(), db_path)
    # La consulta SQL hace todo el trabajo pesado de unir y filtrar
    query <- "
        SELECT AVG(r.punt_global) as avg_score
        FROM Resultados r
        JOIN Colegios c ON r.cole_dane_sede = c.cole_dane_sede
        WHERE c.cole_naturaleza = 'OFICIAL' AND c.cole_municipio = 'BOGOTA D.C.'
    "
    resultado_db <- dbGetQuery(con, query)
    dbDisconnect(con)
    
    end_time_db <- Sys.time()
    # ...
})
</code></pre>
            </div>

            <h2 class="section-title">Estrategias de Conexión en Shiny: Del Prototipo a Producción</h2>
            <div class="content-block">
                <h4>1. Conexión Global (Anti-Patrón)</h4>
                <p>Crear un objeto de conexión en `global.R` y reusarlo es una mala práctica. Las conexiones pueden expirar ("timeout") y no manejan bien múltiples usuarios simultáneos, creando un estado compartido problemático.</p>
                
                <h4>2. Conectar por Consulta (Nuestro Enfoque)</h4>
                <p>Abrir una conexión, ejecutar la consulta y cerrarla inmediatamente dentro de cada `reactive` o `observeEvent` es un patrón muy seguro y robusto. Garantiza que no queden conexiones "colgadas" y es fácil de depurar.</p>

                <h4>3. Connection Pooling (Estándar de la Industria con `pool`)</h4>
                <p>Para aplicaciones con alto tráfico, abrir y cerrar conexiones constantemente es ineficiente. El paquete <code class="inline-code">pool</code> es la solución profesional. Crea un "pool" de conexiones que están siempre abiertas y listas para ser usadas.</p>
                <p><strong>Implementación con `pool`:</strong></p>
<pre><code class="language-r">
# En global.R o al inicio de app.R
library(pool)
db_pool <- dbPool(
    drv = RSQLite::SQLite(),
    dbname = "database/icfes_data.db"
)

# En el server, simplemente usa el pool como si fuera una conexión
# pool se encarga de "prestarte" una conexión y devolverla automáticamente
server <- function(input, output, session) {
    
    datos_filtrados <- reactive({
        # pool maneja la conexión por ti
        dbGetQuery(db_pool, "SELECT * FROM Resultados WHERE punt_global > ?;", params = list(input$slider))
    })
    
    # Al cerrar la app, es crucial cerrar el pool
    onStop(function() {
        poolClose(db_pool)
    })
}
</code></pre>
                <div class="alert alert-info">
                    El paquete <code class="inline-code">pool</code> es el método más eficiente y escalable para aplicaciones Shiny en producción. Aunque nuestro `app.R` usa el método "conectar por consulta" por simplicidad pedagógica, `pool` es el siguiente paso lógico.
                </div>
            </div>

            <div class="nav-buttons">
                <a href="sesion_9.html" class="nav-button back"><i class="fa-solid fa-arrow-left"></i> Volver al Módulo</a>
                <a href="consumo_apis.html" class="nav-button">Siguiente Lección <i class="fa-solid fa-arrow-right"></i></a>
            </div>
        </section>

    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>

